package v2

import (
	"context"
	"fmt"
	"net/http"
)

const (
	createDeprecatedVulnerabilityExceptionListPath = "%s/api/scanning/v1/vulnexceptions"
	getDeprecatedVulnerabilityExceptionListPath    = "%s/api/scanning/v1/vulnexceptions/%s"
	deleteDeprecatedVulnerabilityExceptionListPath = "%s/api/scanning/v1/vulnexceptions/%s"
	updateDeprecatedVulnerabilityExceptionListPath = "%s/api/scanning/v1/vulnexceptions/%s"

	createDeprecatedVulnerabilityExceptionPath = "%s/api/scanning/v1/vulnexceptions/%s/vulnerabilities"
	getDeprecatedVulnerabilityExceptionPath    = "%s/api/scanning/v1/vulnexceptions/%s/vulnerabilities/%s/"
	deleteDeprecatedVulnerabilityExceptionPath = "%s/api/scanning/v1/vulnexceptions/%s/vulnerabilities/%s/"
	updateDeprecatedVulnerabilityExceptionPath = "%s/api/scanning/v1/vulnexceptions/%s/vulnerabilities/%s/"
)

type DeprecatedVulnerabilityExceptionListInterface interface {
	Base
	CreateDeprecatedVulnerabilityExceptionList(ctx context.Context, list *DeprecatedVulnerabilityExceptionList) (*DeprecatedVulnerabilityExceptionList, error)
	GetDeprectedVulnerabilityExceptionListByID(ctx context.Context, id string) (*DeprecatedVulnerabilityExceptionList, error)
	DeleteDeprecatedVulnerabilityExceptionList(ctx context.Context, id string) error
	UpdateDeprecatedVulnerabilityExceptionList(ctx context.Context, list *DeprecatedVulnerabilityExceptionList) (*DeprecatedVulnerabilityExceptionList, error)
}

type DeprecatedVulnerabilityExceptionInterface interface {
	Base
	CreateDeprecatedVulnerabilityException(ctx context.Context, listID string, exception *DeprecatedVulnerabilityException) (*DeprecatedVulnerabilityException, error)
	GetDeprecatedVulnerabilityExceptionByID(ctx context.Context, listID string, exceptionID string) (*DeprecatedVulnerabilityException, error)
	DeleteDeprecatedVulnerabilityException(ctx context.Context, listID string, exceptionID string) error
	UpdateDeprecatedVulnerabilityException(ctx context.Context, listID string, exception *DeprecatedVulnerabilityException) (*DeprecatedVulnerabilityException, error)
}

func (client *Client) CreateDeprecatedVulnerabilityExceptionList(ctx context.Context, list *DeprecatedVulnerabilityExceptionList) (*DeprecatedVulnerabilityExceptionList, error) {
	payload, err := Marshal(list)
	if err != nil {
		return nil, err
	}

	response, err := client.requester.Request(ctx, http.MethodPost, client.createDeprecatedVulnerabilityExceptionListURL(), payload)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityExceptionList](response.Body)
}

func (client *Client) GetDeprectedVulnerabilityExceptionListByID(ctx context.Context, id string) (*DeprecatedVulnerabilityExceptionList, error) {
	response, err := client.requester.Request(ctx, http.MethodGet, client.getDeprecatedVulnerabilityExceptionListURL(id), nil)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityExceptionList](response.Body)
}

func (client *Client) DeleteDeprecatedVulnerabilityExceptionList(ctx context.Context, id string) error {
	response, err := client.requester.Request(ctx, http.MethodDelete, client.deleteDeprecatedVulnerabilityExceptionListURL(id), nil)
	if err != nil {
		return err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusNoContent && response.StatusCode != http.StatusOK && response.StatusCode != http.StatusNotFound {
		return client.ErrorFromResponse(response)
	}

	return nil
}

func (client *Client) UpdateDeprecatedVulnerabilityExceptionList(ctx context.Context, list *DeprecatedVulnerabilityExceptionList) (*DeprecatedVulnerabilityExceptionList, error) {
	payload, err := Marshal(list)
	if err != nil {
		return nil, err
	}

	response, err := client.requester.Request(ctx, http.MethodPut, client.updateDeprecatedVulnerabilityExceptionListURL(list.ID), payload)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityExceptionList](response.Body)
}

func (client *Client) CreateDeprecatedVulnerabilityException(ctx context.Context, listID string, exception *DeprecatedVulnerabilityException) (*DeprecatedVulnerabilityException, error) {
	payload, err := Marshal(exception)
	if err != nil {
		return nil, err
	}

	response, err := client.requester.Request(ctx, http.MethodPost, client.createDeprecatedVulnerabilityExceptionURL(listID), payload)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityException](response.Body)
}

func (client *Client) GetDeprecatedVulnerabilityExceptionByID(ctx context.Context, listID string, exceptionID string) (*DeprecatedVulnerabilityException, error) {
	response, err := client.requester.Request(ctx, http.MethodGet, client.getDeprecatedVulnerabilityExceptionURL(listID, exceptionID), nil)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityException](response.Body)
}

func (client *Client) DeleteDeprecatedVulnerabilityException(ctx context.Context, listID string, exceptionID string) error {
	response, err := client.requester.Request(ctx, http.MethodDelete, client.deleteDeprecatedVulnerabilityExceptionURL(listID, exceptionID), nil)
	if err != nil {
		return err
	}
	defer response.Body.Close()

	// We will ignore the 404 error, because the exception may have been removed if the exception list has been
	// removed as well. This should not affect the user, because removing a non existing exception has no effect.
	if response.StatusCode != http.StatusNoContent && response.StatusCode != http.StatusOK && response.StatusCode != http.StatusNotFound {
		return client.ErrorFromResponse(response)
	}

	return nil
}

func (client *Client) UpdateDeprecatedVulnerabilityException(ctx context.Context, listID string, exception *DeprecatedVulnerabilityException) (*DeprecatedVulnerabilityException, error) {
	payload, err := Marshal(exception)
	if err != nil {
		return nil, err
	}

	response, err := client.requester.Request(ctx, http.MethodPut, client.updateDeprecatedVulnerabilityExceptionURL(listID, exception.ID), payload)
	if err != nil {
		return nil, err
	}
	defer response.Body.Close()

	if response.StatusCode != http.StatusOK && response.StatusCode != http.StatusCreated {
		return nil, client.ErrorFromResponse(response)
	}

	return Unmarshal[*DeprecatedVulnerabilityException](response.Body)
}

func (client *Client) createDeprecatedVulnerabilityExceptionListURL() string {
	return fmt.Sprintf(createDeprecatedVulnerabilityExceptionListPath, client.config.url)
}

func (client *Client) getDeprecatedVulnerabilityExceptionListURL(id string) string {
	return fmt.Sprintf(getDeprecatedVulnerabilityExceptionListPath, client.config.url, id)
}

func (client *Client) deleteDeprecatedVulnerabilityExceptionListURL(id string) string {
	return fmt.Sprintf(deleteDeprecatedVulnerabilityExceptionListPath, client.config.url, id)
}

func (client *Client) updateDeprecatedVulnerabilityExceptionListURL(id string) string {
	return fmt.Sprintf(updateDeprecatedVulnerabilityExceptionListPath, client.config.url, id)
}

func (client *Client) createDeprecatedVulnerabilityExceptionURL(listID string) string {
	return fmt.Sprintf(createDeprecatedVulnerabilityExceptionPath, client.config.url, listID)
}

func (client *Client) getDeprecatedVulnerabilityExceptionURL(listID, ID string) string {
	return fmt.Sprintf(getDeprecatedVulnerabilityExceptionPath, client.config.url, listID, ID)
}

func (client *Client) deleteDeprecatedVulnerabilityExceptionURL(listID, ID string) string {
	return fmt.Sprintf(deleteDeprecatedVulnerabilityExceptionPath, client.config.url, listID, ID)
}

func (client *Client) updateDeprecatedVulnerabilityExceptionURL(listID, ID string) string {
	return fmt.Sprintf(updateDeprecatedVulnerabilityExceptionPath, client.config.url, listID, ID)
}
